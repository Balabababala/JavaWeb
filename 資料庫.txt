1. users - 使用者表
2. roles - 角色表
3. permissions - 權限表
4. role_permissions - 角色權限對應表
5. login_logs 登錄紀錄
6. products - 商品表
7. categories - 商品分類表
8. cart_items - 購物車明細
9. orders - 訂單主表
10. order_items - 訂單明細
11. recently_viewed - 瀏覽歷史
12. search_history  - 歷史收尋
13. recommended_products -推薦
14. product_reviews -     評價
15. 商品評價 不重複
16. notifications - 通知中心

create database shop
char set utf8mb4;

use shop;

CREATE TABLE users (
    id BIGINT PRIMARY KEY COMMENT '使用者 ID',
    username VARCHAR(255) UNIQUE COMMENT '使用者名稱',
    hash_password VARCHAR(255) COMMENT '密碼（加密）',
    hash_salt VARCHAR(255) COMMENT '加鹽',
    email VARCHAR(255) UNIQUE COMMENT '電子郵件',
    role_id BIGINT COMMENT '角色 ID（連接到 roles 表）',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '建立時間',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新時間',
    last_login_at DATETIME COMMENT '最後登入時間（可選）',
    is_active BOOLEAN COMMENT '是否啟用',
    completed BOOLEAN COMMENT '電子郵件是否驗證',
    FOREIGN KEY (role_id) REFERENCES roles(id)
);

CREATE TABLE roles (
    id BIGINT PRIMARY KEY COMMENT '角色 ID',
    name VARCHAR(100) UNIQUE COMMENT '角色名稱（例如：User, Admin, Customer Support）',
    description TEXT COMMENT '角色描述',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '建立時間',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新時間'
);

CREATE TABLE permissions (
    id BIGINT PRIMARY KEY COMMENT '權限 ID',
    name VARCHAR(100) UNIQUE COMMENT '權限名稱（例如：view_orders, manage_products, manage_users）',
    description TEXT COMMENT '權限描述',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '建立時間',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新時間'
);

CREATE TABLE role_permissions (
    role_id BIGINT COMMENT '角色 ID',
    permission_id BIGINT COMMENT '權限 ID',
    assigned_at DATETIME COMMENT '分配時間',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '建立時間',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新時間',
    FOREIGN KEY (role_id) REFERENCES roles(id),
    FOREIGN KEY (permission_id) REFERENCES permissions(id)
);

CREATE TABLE login_logs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT,
    ip_address VARCHAR(45),
    user_agent TEXT,
    login_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    success BOOLEAN,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

CREATE TABLE products (
    id BIGINT PRIMARY KEY COMMENT '商品 ID',
    name VARCHAR(255) COMMENT '商品名稱',
    description TEXT COMMENT '商品描述',
    price DECIMAL(10, 2) COMMENT '價格',
    stock INT COMMENT '庫存數量',
    image_url TEXT COMMENT '商品圖片連結',
    category_id BIGINT COMMENT '所屬分類',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '上架時間',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新時間',
    FOREIGN KEY (category_id) REFERENCES categories(id)
);

CREATE TABLE categories (
    id BIGINT PRIMARY KEY COMMENT '分類 ID',
    name VARCHAR(100) UNIQUE COMMENT '分類名稱',
    parent_id BIGINT COMMENT '父分類 ID（可選，指向自身）',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '建立時間',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新時間',
    FOREIGN KEY (parent_id) REFERENCES categories(id)
);

CREATE TABLE cart_items (
    id BIGINT PRIMARY KEY COMMENT '購物車項目 ID',
    user_id BIGINT COMMENT '所屬使用者 ID',
    product_id BIGINT COMMENT '商品 ID',
    quantity INT CHECK (quantity > 0) COMMENT '數量',
    added_at DATETIME COMMENT '加入時間',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新時間',
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (product_id) REFERENCES products(id)
);

CREATE TABLE orders (
    id BIGINT PRIMARY KEY COMMENT '訂單 ID',
    user_id BIGINT COMMENT '購買人 ID',
    seller_id BIGINT COMMENT '賣方 ID',
    order_date DATETIME COMMENT '下單時間',
    order_status ENUM('PENDING', 'PAID', 'SHIPPED', 'DELIVERED', 'COMPLETED', 'CANCELLED', 'RETURN_REQUESTED', 'RETURNED') COMMENT '訂單狀態',
    payment_status ENUM('PENDING', 'PAID', 'FAILED', 'REFUNDED') COMMENT '付款狀態',
    shipment_status ENUM('NOT_SHIPPED', 'SHIPPED', 'IN_TRANSIT', 'DELIVERED', 'RETURNING') COMMENT '出貨與物流進度',
    shipping_method VARCHAR(100) COMMENT '配送方式',
    payment_method VARCHAR(100) COMMENT '付款方式',
    tracking_number VARCHAR(255) COMMENT '物流單號',
    receiver_name VARCHAR(255) COMMENT '收件人姓名',
    receiver_phone VARCHAR(20) COMMENT '收件人電話',
    total_amount DECIMAL(10, 2) COMMENT '訂單總金額',
    shipping_address TEXT COMMENT '收貨地址',
    notes TEXT COMMENT '備註',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '建立時間',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新時間',
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (seller_id) REFERENCES users(id)
);

CREATE TABLE order_items (
    id BIGINT PRIMARY KEY COMMENT '明細 ID',
    order_id BIGINT COMMENT '所屬訂單 ID',
    product_id BIGINT COMMENT '商品 ID',
    quantity INT CHECK (quantity > 0) COMMENT '數量',
    unit_price DECIMAL(10, 2) COMMENT '商品單價',
    total_price DECIMAL(10, 2) COMMENT '商品總價',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '建立時間',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新時間',
    FOREIGN KEY (order_id) REFERENCES orders(id),
    FOREIGN KEY (product_id) REFERENCES products(id)
);

CREATE TABLE recently_viewed (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '歷史紀錄 ID',
    user_id BIGINT COMMENT '用戶 ID',
    product_id BIGINT COMMENT '商品 ID',
    viewed_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '瀏覽時間',
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (product_id) REFERENCES products(id)
);

CREATE TABLE search_history (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '搜尋紀錄 ID',
    user_id BIGINT COMMENT '使用者 ID',
    keyword VARCHAR(255) COMMENT '搜尋關鍵字',
    searched_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '搜尋時間',
    FOREIGN KEY (user_id) REFERENCES users(id)
);

CREATE TABLE recommended_products (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '推薦紀錄 ID',
    user_id BIGINT NOT NULL COMMENT '使用者 ID',
    product_id BIGINT NOT NULL COMMENT '被推薦的商品 ID',
    reason VARCHAR(255) COMMENT '推薦原因（例如：based on your recent views）',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '建立時間',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新時間',
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (product_id) REFERENCES products(id)
);

CREATE TABLE product_reviews (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '評價唯一 ID',
    user_id BIGINT COMMENT '用戶 ID',
    product_id BIGINT COMMENT '商品 ID',
    rating INT CHECK (rating BETWEEN 1 AND 5) COMMENT '評分',
    comment TEXT COMMENT '評價內容',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '評價時間',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新時間',
    is_visible BOOLEAN DEFAULT TRUE COMMENT '評價是否公開',
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (product_id) REFERENCES products(id)
);

CREATE UNIQUE INDEX idx_user_product ON product_reviews (user_id, product_id);

CREATE TABLE notifications (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '通知 ID',
    user_id BIGINT NOT NULL COMMENT '相關的員工或用戶 ID',
    type VARCHAR(100) COMMENT '通知類型（例如：支付、出貨、庫存警告等）',
    message TEXT COMMENT '通知內容',
    status ENUM('PENDING', 'READ', 'ARCHIVED') DEFAULT 'PENDING' COMMENT '通知狀態',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '通知創建時間',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '通知更新時間',
    FOREIGN KEY (user_id) REFERENCES users(id)
);